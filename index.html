<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Neumáticos Palmones - Presupuestos</title>

    <!-- Materialize CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

    <!-- Favicon inline para evitar 404 en /favicon.ico -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect fill='%230b63f6' width='64' height='64' rx='8'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='36' font-family='Segoe UI, Arial' fill='white'%3EN%3C/text%3E%3C/svg%3E"
    />

    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Toolbar compacto -->
    <div class="compact-toolbar">
      <div class="toolbar-brand">
        <i class="material-icons">build</i>
        Neumáticos Palmones
      </div>
      <span
        id="loaded-presupuesto-badge"
        class="toolbar-badge"
        style="display: none"
        data-badge-caption=""
      ></span>

      <!-- Grupo: Presupuestos -->
      <button id="btnNuevoPresupuesto" class="toolbar-btn primary">
        <i class="material-icons">add</i>Nuevo
      </button>
      <button id="btnGuardarPresupuesto" class="toolbar-btn success">
        <i class="material-icons">save</i>Guardar
      </button>
      <button id="btnCancelarEdicionTop" class="toolbar-btn orange" style="display: none">
        <i class="material-icons">cancel</i>Cancelar
      </button>

      <!-- Grupo: Navegación -->
      <button id="btnVerHistorial" class="toolbar-btn blue">
        <i class="material-icons">history</i>Historial
      </button>
      <button id="btnVerPedidos" class="toolbar-btn purple">
        <i class="material-icons">shopping_cart</i>Pedidos
      </button>

      <!-- Grupo: Exportar -->
      <button id="btnImprimirPresupuesto" class="toolbar-btn">
        <i class="material-icons">print</i>PDF
      </button>
      <button id="btnCompartirWhatsApp" class="toolbar-btn">
        <i class="material-icons">message</i>WhatsApp
      </button>

      <!-- Grupo: Acciones -->
      <button id="btnVaciarGrupos" class="toolbar-btn">
        <i class="material-icons">clear_all</i>Vaciar
      </button>
      <button id="btnCargarSugerencias" class="toolbar-btn">
        <i class="material-icons">lightbulb_outline</i>Sugerencias
      </button>

      <!-- Grupo: Vista -->
      <button class="toolbar-btn"><i class="material-icons">visibility</i>Vista</button>

      <!-- Herramientas -->
      <div style="margin-left: auto; display: flex; gap: 6px">
        <span id="connDot" class="status-dot" title="Estado de conexión"></span>
        <span id="connText" style="font-size: 10px; color: #666">Conectado</span>
        <button id="btnCopyHostURL" class="toolbar-btn">
          <i class="material-icons">link</i>
        </button>
      </div>
    </div>

    <!-- Container principal compacto -->
    <div class="main-container">
      <!-- Sección cliente y formulario más compacta -->
      <div class="left-content">
        <!-- Datos cliente súper compactos -->
        <div class="cliente-section">
          <div class="section-title">
            <i class="material-icons">person</i>
            Datos del Cliente
          </div>
          <form id="cliente-form" onsubmit="return false;">
            <div class="form-row">
              <div class="input-column">
                <div class="input-compact">
                  <label for="presupuesto-nombreCliente">Nombre y Apellidos</label>
                  <input type="text" id="presupuesto-nombreCliente" class="validate" />
                </div>
                <div class="input-compact">
                  <label for="presupuesto-numeroPresupuesto">Nº Presupuesto</label>
                  <input type="text" id="presupuesto-numeroPresupuesto" class="validate" />
                </div>
                <div class="input-compact">
                  <label for="presupuesto-distribuidor">Distribuidor</label>
                  <input type="text" id="presupuesto-distribuidor" class="validate" />
                </div>
              </div>
              <div class="input-column">
                <div class="input-compact">
                  <label for="presupuesto-telefonoCliente">Teléfono</label>
                  <input type="tel" id="presupuesto-telefonoCliente" class="validate" />
                </div>
                <div class="input-compact">
                  <label for="presupuesto-fechaPresupuesto">Fecha</label>
                  <input type="date" id="presupuesto-fechaPresupuesto" class="validate" />
                </div>
                <div class="input-compact">
                  <label for="presupuesto-descripcion">Descripción (Calendar)</label>
                  <input type="text" id="presupuesto-descripcion" class="validate" />
                </div>
              </div>
              <div class="input-column">
                <div class="input-compact">
                  <label for="presupuesto-nifCliente">NIF/CIF</label>
                  <input type="text" id="presupuesto-nifCliente" class="validate" />
                </div>
                <div class="input-compact">
                  <label for="presupuesto-observaciones">Observaciones</label>
                  <input type="text" id="presupuesto-observaciones" class="validate" />
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- Añadir productos súper compacto -->
        <div class="add-product-section">
          <div class="section-title">
            <i class="material-icons">add_shopping_cart</i>
            Añadir Productos
          </div>
          <form id="producto-form" onsubmit="return false;">
            <div class="product-form-row">
              <div class="input-compact">
                <label for="presupuesto-medida">Medida</label>
                <input type="text" id="presupuesto-medida" />
              </div>
              <div class="input-compact">
                <label for="presupuesto-cantidad">Cant.</label>
                <input type="number" id="presupuesto-cantidad" min="1" value="2" />
              </div>
              <div class="input-compact">
                <label for="presupuesto-marca-temp">Marca</label>
                <input type="text" id="presupuesto-marca-temp" />
              </div>
              <div class="input-compact">
                <label for="presupuesto-neto-temp">Precio Neto</label>
                <input type="number" id="presupuesto-neto-temp" step="0.01" />
              </div>
              <div class="input-compact">
                <label for="presupuesto-ganancia">Ganancia</label>
                <input type="number" id="presupuesto-ganancia" step="0.01" value="0" />
              </div>
              <div class="input-compact">
                <label for="presupuesto-iva">IVA %</label>
                <input type="number" id="presupuesto-iva" step="0.01" value="21" />
              </div>
              <button type="button" id="btnAgregarMarca" class="btn-add">
                <i class="material-icons">add</i>
                Añadir
              </button>
            </div>

            <!-- Sugerencias compactas -->
            <div class="suggestions-section">
              <div class="suggestions-title">Sugerencias por Medida</div>
              <div class="chips-container" id="precios-por-medida"></div>
              <div class="suggestions-title">Códigos Filtrados</div>
              <div class="chips-container" id="precios-filtros-codigo"></div>
            </div>

            <!-- Marcas temporales compactas -->
            <div class="brands-temp-section">
              <div id="lista-marcas-temp"></div>
              <div id="lista-otros-trabajos-temp"></div>

              <!-- Botones de acción principales -->
              <div style="margin-top: 8px; display: flex; gap: 6px">
                <button
                  type="button"
                  id="btnAgregarOtroTrabajo"
                  class="btn-add"
                  style="background: #8b5cf6"
                >
                  <i class="material-icons">build</i>
                  Otro Trabajo
                </button>
                <button
                  type="button"
                  id="btnAgregarGrupo"
                  class="btn-add"
                  style="background: #2563eb; flex: 1"
                >
                  <i class="material-icons">playlist_add</i>
                  Agregar Grupo
                </button>
              </div>
            </div>
          </form>
        </div>

        <!-- Tabla de productos -->
        <div class="products-table">
          <div class="table-header">
            <i class="material-icons">list</i>
            Lista de Productos
          </div>
          <div class="table-content">
            <table>
              <thead>
                <tr>
                  <th>Medida</th>
                  <th>Cant.</th>
                  <th>Marca</th>
                  <th>Precio Unit.</th>
                  <th>Total</th>
                  <th>Acc.</th>
                </tr>
              </thead>
              <tbody id="items-list">
                <!-- Productos dinámicos -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Panel derecho -->
      <div class="right-panel">
        <!-- Presupuesto final -->
        <div class="presupuesto-final">
          <div class="presupuesto-header">
            <div>
              <div>NEUMÁTICOS PALMONES</div>
              <div class="presupuesto-meta">C/GALEON 25 - Tel: 659 718 809</div>
            </div>
            <div style="text-align: right">
              <div>PRESUPUESTO</div>
              <div class="presupuesto-meta" id="presupuesto-numero-display">Nº: ---</div>
            </div>
          </div>
          <div class="presupuesto-content" id="presupuesto-final-content">
            <!-- Contenido dinámico del presupuesto -->
            <div id="presupuesto-final-render"></div>
          </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="actions-compact">
          <div class="action-grid">
            <button class="action-btn-small primary" id="btnGuardarComoNuevo" style="display: none">
              <i class="material-icons">content_copy</i>
              Guardar como Nuevo
            </button>
            <button class="action-btn-small" id="btnVaciarTemporales">
              <i class="material-icons">delete_sweep</i>
              Vaciar Temp.
            </button>
            <button class="action-btn-small" id="btnDescargarPDF">
              <i class="material-icons">picture_as_pdf</i>
              PDF
            </button>
            <button class="action-btn-small" id="btnCapturaWhatsApp">
              <i class="material-icons">photo_camera</i>
              Captura
            </button>
            <button class="action-btn-small" id="btnCopiarCalendar">
              <i class="material-icons">event</i>
              Copiar Cal.
            </button>
            <button class="action-btn-small" id="btnAbrirCalendar">
              <i class="material-icons">open_in_new</i>
              Abrir Cal.
            </button>
            <button class="action-btn-small" id="btnCancelarEdicion" style="display: none">
              <i class="material-icons">undo</i>
              Cancelar Ed.
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modales del sistema -->

    <!-- Modal Historial -->
    <div id="historial-modal" class="modal-overlay" style="display: none">
      <div class="modal-content-historial">
        <div class="modal-header-historial">
          <h3>
            <i class="material-icons">history</i>
            Historial de Presupuestos
          </h3>
          <button class="modal-close" data-modal="historial-modal">
            <i class="material-icons">close</i>
          </button>
        </div>

        <!-- Panel de búsqueda -->
        <div class="search-panel-historial">
          <div class="search-inputs">
            <input type="text" id="hist-buscar-nombre" placeholder="Nombre cliente..." />
            <input type="text" id="hist-buscar-telefono" placeholder="Teléfono..." />
            <input type="text" id="hist-buscar-medida" placeholder="Medida..." />
            <input type="text" id="hist-buscar-numero" placeholder="Nº presupuesto..." />
            <button id="hist-buscar-btn" class="btn-search">
              <i class="material-icons">search</i>Buscar
            </button>
            <button id="hist-limpiar-btn" class="btn-clear">
              <i class="material-icons">clear</i>Limpiar
            </button>
          </div>
        </div>

        <!-- Estadísticas -->
        <div class="stats-panel-historial">
          <div class="stat-item">
            <div class="stat-number" id="stat-total">156</div>
            <div class="stat-label">Total Presupuestos</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="stat-monto">€12,450</div>
            <div class="stat-label">Monto Total</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="stat-mes">23</div>
            <div class="stat-label">Este Mes</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="stat-clientes">89</div>
            <div class="stat-label">Clientes Únicos</div>
          </div>
        </div>

        <!-- Lista de presupuestos -->
        <div class="presupuestos-list-historial">
          <div class="list-header">
            <span>Mostrando resultados de búsqueda</span>
            <div class="list-actions">
              <button class="btn-export">
                <i class="material-icons">file_download</i>Exportar
              </button>
            </div>
          </div>
          <div class="list-content" id="lista-historial">
            <!-- Lista dinámica de presupuestos -->
          </div>
        </div>

        <!-- Navegación -->
        <div class="modal-navigation">
          <div id="paginacion-container"></div>
        </div>
      </div>
    </div>

    <!-- Modal Pedidos -->
    <div id="pedidos-modal" class="modal-overlay" style="display: none">
      <div class="modal-content-pedidos">
        <div class="modal-header-pedidos">
          <h3>
            <i class="material-icons">shopping_cart</i>
            Gestión de Pedidos
          </h3>
          <button class="modal-close" data-modal="pedidos-modal">
            <i class="material-icons">close</i>
          </button>
        </div>

        <!-- Filtros de pedidos -->
        <div class="filters-panel-pedidos">
          <div class="filters-row">
            <input type="text" id="ped-filtro-texto" placeholder="Buscar..." />
            <input type="text" id="ped-filtro-proveedor" placeholder="Proveedor..." />
            <select id="ped-filtro-estado">
              <option value="">Todos los estados</option>
              <option value="pending">Pendientes</option>
              <option value="ordered">Pedidos</option>
              <option value="received">Recibidos</option>
            </select>
            <input type="date" id="ped-filtro-desde" />
            <input type="date" id="ped-filtro-hasta" />
            <button id="ped-btn-filtrar" class="btn-filter">
              <i class="material-icons">filter_alt</i>Filtrar
            </button>
          </div>
          <div class="actions-row">
            <button id="ped-btn-nuevo" class="btn-new-pedido">
              <i class="material-icons">add</i>Nuevo Pedido
            </button>
            <button id="ped-btn-limpiar" class="btn-clear">
              <i class="material-icons">clear</i>Limpiar
            </button>
          </div>
        </div>

        <!-- Lista de pedidos -->
        <div class="pedidos-list">
          <div class="list-content" id="pedidos-lista">
            <!-- Lista dinámica de pedidos -->
          </div>
        </div>

        <!-- Paginación de pedidos -->
        <div class="modal-navigation">
          <div id="pedidos-paginacion"></div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module" src="js/main.js"></script>
    <script type="module" src="js/modal.js"></script>
    <script src="debug_autoadd.js"></script>

    <!-- Loader Overlay -->
    <div id="loader-overlay" class="loader-overlay">
      <div class="loader-content">
        <div class="preloader-wrapper big active">
          <div class="spinner-layer spinner-blue-only">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
        <p id="loader-text">Procesando...</p>
      </div>
    </div>

    <!-- Modal de Confirmación Genérico -->
    <div id="confirm-modal" class="modal-modern">
      <div class="modal-overlay" id="modal-overlay"></div>
      <div class="modal-container">
        <div class="modal-header">
          <h4 id="confirm-modal-title" class="modal-title">
            <i class="material-icons left modal-icon">help_outline</i>
            Confirmar Acción
          </h4>
          <button class="modal-close-btn" id="modal-close-btn">
            <i class="material-icons">close</i>
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-content-wrapper">
            <div class="modal-icon-large" id="modal-icon-large">
              <i class="material-icons">help_outline</i>
            </div>
            <div class="modal-text">
              <p id="confirm-modal-content" class="modal-message">
                ¿Estás seguro de realizar esta acción?
              </p>
              <p id="confirm-modal-subtitle" class="modal-subtitle" style="display: none">
                Esta acción no se puede deshacer.
              </p>
            </div>
          </div>
        </div>
        <div class="modal-footer-modern">
          <button class="btn-modal-modern secondary" id="confirm-modal-cancel">
            <i class="material-icons left">close</i>
            Cancelar
          </button>
          <button class="btn-modal-modern primary" id="confirm-modal-accept">
            <i class="material-icons left">check</i>
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Información/Éxito -->
    <div id="info-modal" class="modal-modern">
      <div class="modal-overlay"></div>
      <div class="modal-container">
        <div class="modal-header">
          <h4 id="info-modal-title" class="modal-title">
            <i class="material-icons left modal-icon">info</i>
            Información
          </h4>
          <button class="modal-close-btn">
            <i class="material-icons">close</i>
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-content-wrapper">
            <div class="modal-icon-large success" id="info-modal-icon">
              <i class="material-icons">check_circle</i>
            </div>
            <div class="modal-text">
              <p id="info-modal-content" class="modal-message">
                Operación completada exitosamente.
              </p>
            </div>
          </div>
        </div>
        <div class="modal-footer-modern">
          <button class="btn-modal-modern primary modal-close">
            <i class="material-icons left">done</i>
            Entendido
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Error -->
    <div id="error-modal" class="modal-modern">
      <div class="modal-overlay"></div>
      <div class="modal-container">
        <div class="modal-header error">
          <h4 id="error-modal-title" class="modal-title">
            <i class="material-icons left modal-icon">error</i>
            Error
          </h4>
          <button class="modal-close-btn">
            <i class="material-icons">close</i>
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-content-wrapper">
            <div class="modal-icon-large error">
              <i class="material-icons">error</i>
            </div>
            <div class="modal-text">
              <p id="error-modal-content" class="modal-message">Ha ocurrido un error inesperado.</p>
              <p id="error-modal-details" class="modal-details" style="display: none"></p>
            </div>
          </div>
        </div>
        <div class="modal-footer-modern">
          <button class="btn-modal-modern secondary modal-close">
            <i class="material-icons left">close</i>
            Cerrar
          </button>
          <button class="btn-modal-modern primary" id="error-modal-retry" style="display: none">
            <i class="material-icons left">refresh</i>
            Reintentar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Formulario -->
    <div id="form-modal" class="modal-modern modal-large">
      <div class="modal-overlay"></div>
      <div class="modal-container">
        <div class="modal-header">
          <h4 id="form-modal-title" class="modal-title">
            <i class="material-icons left modal-icon">edit</i>
            Editar Información
          </h4>
          <button class="modal-close-btn">
            <i class="material-icons">close</i>
          </button>
        </div>
        <div class="modal-body">
          <form id="form-modal-form" class="modal-form">
            <div id="form-modal-content" class="form-content">
              <!-- Contenido dinámico del formulario -->
            </div>
          </form>
        </div>
        <div class="modal-footer-modern">
          <button class="btn-modal-modern secondary modal-close">
            <i class="material-icons left">close</i>
            Cancelar
          </button>
          <button class="btn-modal-modern primary" id="form-modal-submit">
            <i class="material-icons left">save</i>
            Guardar
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
