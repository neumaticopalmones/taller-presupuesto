<!doctype html>
<html>
  <head>
    <title>Test Auto-Add Functionality</title>
    <style>
      body {
        font-family: monospace;
        background: #1a1a1a;
        color: #00ff00;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 10px;
        border: 1px solid #333;
      }
      .pass {
        color: #00ff00;
      }
      .fail {
        color: #ff0000;
      }
      .warning {
        color: #ffaa00;
      }
      .info {
        color: #00aaff;
      }
    </style>
  </head>
  <body>
    <h1>🧪 TEST AUTO-ADD FUNCTIONALITY</h1>
    <div id="test-results"></div>

    <script>
      async function runTests() {
        const results = document.getElementById("test-results");

        function log(message, type = "info") {
          const div = document.createElement("div");
          div.className = type;
          div.innerHTML = message;
          results.appendChild(div);
          console.log(message);
        }

        log("=== INICIANDO TESTS AUTOMATIZADOS ===", "info");

        // Test 1: Verificar que la aplicación esté corriendo
        log("\n📡 TEST 1: Conectividad con aplicación", "info");
        try {
          const response = await fetch("http://localhost:5000");
          if (response.ok) {
            log("✅ Aplicación accesible en localhost:5000", "pass");
          } else {
            log("❌ Aplicación no responde correctamente", "fail");
          }
        } catch (e) {
          log("❌ Error conectando con aplicación: " + e.message, "fail");
          return;
        }

        // Test 2: Verificar endpoint de sugerencias
        log("\n🔍 TEST 2: API de sugerencias", "info");
        try {
          const response = await fetch("http://localhost:5000/api/sugerencias");
          if (response.ok) {
            const data = await response.json();
            log("✅ API sugerencias responde correctamente", "pass");
            log(
              `📊 Datos recibidos: ${data.medidas?.length || 0} medidas, ${data.marcas?.length || 0} marcas`,
              "info"
            );

            // Mostrar sample de datos
            if (data.medidas && data.medidas.length > 0) {
              log(`🔸 Medidas ejemplo: ${data.medidas.slice(0, 3).join(", ")}...`, "info");
            }
            if (data.marcas && data.marcas.length > 0) {
              log(`🔸 Marcas ejemplo: ${data.marcas.slice(0, 3).join(", ")}...`, "info");
            }
          } else {
            log("❌ API sugerencias falla: " + response.status, "fail");
          }
        } catch (e) {
          log("❌ Error en API sugerencias: " + e.message, "fail");
        }

        // Test 3: Simular request de validación
        log("\n📝 TEST 3: Lógica de validación", "info");

        // Simular datos de entrada
        const testData = {
          medida: "175/65 R14",
          cantidad: "2",
          marca: "MICHELIN",
          neto: "45.50",
          ganancia: "", // Vacío para test
          ecotasa: "", // Vacío para test
          iva: "", // Vacío para test
        };

        log("🧪 Datos de prueba:", "info");
        Object.keys(testData).forEach((key) => {
          log(
            `   ${key}: "${testData[key]}" ${testData[key] ? "✅" : "❌"}`,
            testData[key] ? "pass" : "warning"
          );
        });

        // Simular validación básica (4 campos)
        const validacionBasica =
          testData.medida && testData.cantidad && testData.marca && testData.neto;
        log(
          `\n📋 VALIDACIÓN BÁSICA (4 campos): ${validacionBasica ? "✅ PASS" : "❌ FAIL"}`,
          validacionBasica ? "pass" : "fail"
        );

        // Simular validación completa (7 campos)
        const validacionCompleta =
          testData.medida &&
          testData.cantidad &&
          testData.marca &&
          testData.neto &&
          testData.ganancia &&
          testData.ecotasa &&
          testData.iva;
        log(
          `📋 VALIDACIÓN COMPLETA (7 campos): ${validacionCompleta ? "✅ PASS" : "❌ FAIL"}`,
          validacionCompleta ? "pass" : "fail"
        );

        if (validacionBasica && !validacionCompleta) {
          log("⚠️ PROBLEMA DETECTADO: Validación básica pasa pero completa falla", "warning");
          log(
            "💡 SOLUCIÓN: La función auto-add debe usar validación BÁSICA, no completa",
            "warning"
          );
        }

        // Test 4: Verificar estructura HTML esperada
        log("\n🏗️ TEST 4: Simulación de estructura HTML", "info");

        const expectedElements = [
          "presupuesto-medida",
          "presupuesto-cantidad",
          "presupuesto-marca-temp",
          "presupuesto-neto-temp",
          "presupuesto-ganancia",
          "presupuesto-ecotasa",
          "presupuesto-iva",
          "btnAgregarMarca",
        ];

        log("📋 Elementos requeridos en DOM:", "info");
        expectedElements.forEach((id) => {
          log(`   #${id}: Se espera que exista`, "info");
        });

        log("\n✅ TESTS COMPLETADOS", "pass");
        log(
          "🔧 PRÓXIMO PASO: Abrir http://localhost:5000 y ejecutar testAutoAdd() en consola",
          "info"
        );
        log("💡 TIP: Abre F12 > Consola en el navegador para ver logs detallados", "info");
      }

      // Ejecutar tests al cargar
      runTests();
    </script>
  </body>
</html>
